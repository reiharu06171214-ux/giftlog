{% extends "base.html" %}
{% import "macros.html" as macros %}
{% block content %}
  <div class="card">
    <h2>ギフト追加</h2>

    <form id="gift-form" method="post" class="grid cols-2" style="gap:12px;">
      <!-- タイトル -->
      <div class="form-group">
        <label for="title">タイトル*</label>
        <input id="title" name="title" required autofocus autocomplete="off"
               placeholder="例: バースデーケーキ"
               value="{{ request.form.get('title','') }}">
      </div>

      <!-- もらった日 -->
      <div class="form-group">
        <label>もらった日</label>
        {{ macros.date_select('received', years, today, request.form) }}
      </div>

      <!-- 金額 -->
      <div class="form-group">
        <label for="amount_yen">金額（任意）</label>
        <input id="amount_yen" name="amount_yen" type="number" min="0" step="1" inputmode="numeric"
               placeholder="例: 3000" value="{{ request.form.get('amount_yen','') }}">
        <span class="small">※ 半角数字。未入力でもOKだよ</span>
      </div>

      <!-- 贈り主 -->
      <div class="form-group">
        <label for="giver_id">送ってくれた方</label>
        <select id="giver_id" name="giver_id">
          <option value="">（未選択）</option>
          {% for g in givers %}
            <option value="{{ g.id }}"
              {% if request.form.get('giver_id') and request.form.get('giver_id')|int == g.id %}selected{% endif %}>
              {{ g.name }}
            </option>
          {% endfor %}
        </select>
        <span class="small"><a href="{{ url_for('givers') }}">＋ 贈り主を追加</a></span>
      </div>

      <!-- カテゴリ -->
      <div class="form-group">
        <label for="category_id">カテゴリ</label>
        <select id="category_id" name="category_id">
          <option value="">（未選択）</option>
          {% for c in categories %}
            <option value="{{ c.id }}"
              {% if request.form.get('category_id') and request.form.get('category_id')|int == c.id %}selected{% endif %}>
              {{ c.name }}
            </option>
          {% endfor %}
        </select>
        <span class="small"><a href="{{ url_for('categories') }}">＋ カテゴリを追加</a></span>
      </div>

      <!-- お返しする日 -->
      <div class="form-group">
        <label>お返しする日</label>
        {{ macros.date_select('return_due', years, today, request.form) }}
      </div>

      <!-- チェック類（任意） -->
      <div class="checks-row">
        <label class="check">
          <input type="checkbox" name="thank_you_sent" {% if request.form.get('thank_you_sent') %}checked{% endif %}>
          ありがとう連絡 済
        </label>
        <label class="check">
          <input type="checkbox" name="return_done" {% if request.form.get('return_done') %}checked{% endif %}>
          お返しOK 済
        </label>
      </div>

      <!-- メモ -->
      <div class="form-group" style="grid-column:1/-1;">
        <label for="memo">メモ</label>
        <textarea id="memo" name="memo" rows="3"
                  placeholder="例: お返しは焼き菓子セットにする予定など">{{ request.form.get('memo','') }}</textarea>
      </div>

      <!-- ボタン -->
      <div class="form-actions">
        <button class="btn btn-search" type="submit">登録</button>
        <a class="btn" href="{{ url_for('gifts') }}">← 一覧へ</a>
      </div>
    </form>

    <!-- draft auto-save（既存JSをそのまま利用OK） -->
    <script>
    (() => {
      const STORAGE_KEY = "giftlog:draft:gifts:new";
      const form = document.getElementById("gift-form");
      if (!form) return;
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (raw) {
          const data = JSON.parse(raw);
          for (const el of form.querySelectorAll("input, select, textarea")) {
            if (!el.name) continue;
            const v = data[el.name];
            if (v === undefined) continue;
            if (el.type === "checkbox" || el.type === "radio") {
              el.checked = !!v;
            } else {
              el.value = v;
            }
          }
        }
      } catch (e) {}
      let saveTimer = null;
      const save = () => {
        const dump = {};
        for (const el of form.querySelectorAll("input, select, textarea")) {
          if (!el.name) continue;
          if (el.type === "checkbox" || el.type === "radio") {
            dump[el.name] = el.checked;
          } else {
            dump[el.name] = el.value;
          }
        }
        try { localStorage.setItem(STORAGE_KEY, JSON.stringify(dump)); } catch {}
      };
      const onChange = () => { clearTimeout(saveTimer); saveTimer = setTimeout(save, 300); };
      form.addEventListener("input", onChange, true);
      form.addEventListener("change", onChange, true);
      form.addEventListener("submit", () => { try { localStorage.removeItem(STORAGE_KEY); } catch {} });
    })();
    </script>
  </div>
{% endblock %}
