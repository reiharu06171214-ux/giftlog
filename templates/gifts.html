{% extends "base.html" %}
{% block content %}

  <div class="card">
    <h2>検索・フィルタ</h2>
    <form method="get" class="grid" style="grid-template-columns:repeat(6,1fr);gap:10px;">
      <div class="form-group">
        <label for="q">キーワード</label>
        <input id="q" name="q" value="{{ q or '' }}" placeholder="タイトルで検索">
      </div>

      <div class="form-group">
        <label for="giver_id">贈り主</label>
        <select id="giver_id" name="giver_id">
          <option value="">(すべて)</option>
          {% for g in givers %}
            <option value="{{ g.id }}" {% if selected_giver_id == g.id %}selected{% endif %}>{{ g.name }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="form-group">
        <label for="category_id">カテゴリ</label>
        <select id="category_id" name="category_id">
          <option value="">(すべて)</option>
          {% for c in categories %}
            <option value="{{ c.id }}" {% if selected_category_id == c.id %}selected{% endif %}>{{ c.name }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="form-group">
        <label for="min_amount">金額 最小（円）</label>
        <input id="min_amount" name="min_amount" type="number" min="0" step="100"
               value="{{ min_amount if min_amount is not none else '' }}" placeholder="例: 1000">
      </div>

      <div class="form-group">
        <label for="max_amount">金額 最大（円）</label>
        <input id="max_amount" name="max_amount" type="number" min="0" step="100"
               value="{{ max_amount if max_amount is not none else '' }}" placeholder="例: 5000">
      </div>

      <div class="filters-bottom">
        <div class="chk-group">
          <label class="chk"><input type="checkbox" name="amount_only" value="1" {% if amount_only %}checked{% endif %}> 金額ありのみ</label>
          <label class="chk"><input type="checkbox" name="todo" value="1" {% if only_todo %}checked{% endif %}> 返礼ToDoのみ</label>
        </div>
        <button class="btn btn-search" type="submit">検索</button>
      </div>
    </form>
  </div>

  <div class="card">
    <h2>ギフト一覧</h2>
    {% if gifts %}
      <table class="table" aria-label="ギフト一覧">
        <thead>
          <tr>
            <th scope="col">受領日</th>
            <th scope="col">タイトル</th>
            <th scope="col">贈り主</th>
            <th scope="col">カテゴリ</th>
            <th scope="col">金額</th>
            <th scope="col">返礼目安</th>
            <th scope="col">お礼</th>
            <th scope="col">返礼期日</th>
            <th scope="col">返礼OK</th>
            <th scope="col"></th>
          </tr>
        </thead>
        <tbody>
          {% for g in gifts %}
          <tr>
            <td>{{ g.received_date|datejp }}</td>
            <td>{{ g.title }}</td>
            <td>{{ g.giver.name if g.giver else '' }}</td>
            <td>{{ g.category.name if g.category else '' }}</td>
            <td>{{ g.amount_yen|yen }}</td>
            <td class="small">
              {% if g.amount_yen %}
                目安 ~ {{ (g.amount_yen * 0.4)|round|int|yen }}
              {% endif %}
            </td>
            <td>{% if g.thank_you_sent %}<span class="chip">✅ 済</span>{% else %}<span class="small">未</span>{% endif %}</td>
            <td>{{ g.return_due_date|datejp }}</td>
            <td>{% if g.return_done %}<span class="chip">✅ 済</span>{% else %}<span class="small">未</span>{% endif %}</td>
            <td><a class="btn" href="{{ url_for('gift_edit', gift_id=g.id) }}">編集</a></td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    {% else %}
      <p>まだ登録がありません。<a href="{{ url_for('gift_new') }}">ギフトを追加</a>してね。</p>
    {% endif %}
  </div>

  {% if gifts %}
    <div class="card">
      <h3>集計</h3>
      <p>合計金額: <strong>{{ total_amount|yen }}</strong></p>
      <p>平均金額: <strong>{% if avg_amount %}{{ avg_amount|yen }}{% else %}-{% endif %}</strong></p>

      <h4>カテゴリ別合計</h4>
      {% if category_totals %}
        <ul>
          {% for cat, total in category_totals.items() %}
            <li>{{ cat }}: {{ total|yen }}</li>
          {% endfor %}
        </ul>
      {% else %}
        <p class="small">金額が未入力のため集計できません。</p>
      {% endif %}
    </div>
  {% endif %}
{% endblock %}
